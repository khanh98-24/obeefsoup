@using OBeefSoup.Areas.Admin.Models
@model DashboardViewModel
@{
    ViewData["Title"] = "Bảng Điều Khiển - O' BeefSoup";
    Layout = "_AdminLayout";
}

<div class="container-fluid">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 mb-4">
        <div>
            <h3 class="fw-bold mb-0">Tổng quan hệ thống</h3>
            <p class="text-muted small mb-0">Chào mừng trở lại! Đây là tóm tắt hoạt động kinh doanh của bạn.</p>
        </div>
        <div class="d-flex gap-2 w-100 w-md-auto">
            <button class="btn btn-white shadow-sm btn-sm border flex-grow-1 flex-md-grow-0" onclick="window.location.reload()">
                <i class="bi bi-arrow-clockwise me-1"></i> <span class="d-none d-sm-inline">Làm mới</span>
            </button>
            <button class="btn btn-primary btn-sm shadow-sm flex-grow-1 flex-md-grow-0">
                <i class="bi bi-download me-1"></i> <span class="d-none d-sm-inline">Xuất báo cáo</span>
                <i class="bi bi-download d-sm-none"></i>
            </button>
        </div>
    </div>

    <!-- Stats Row -->
    <div class="row g-3 g-md-4 mb-4">
        <div class="col-6 col-md-3">
            <div class="card h-100 border-0 shadow-sm overflow-hidden" style="background: linear-gradient(135deg, #1e3c72, #2a5298);">
                <div class="card-body text-white position-relative p-3 p-md-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="z-1">
                            <h6 class="text-white-50 x-small mb-1">DOANH THU</h6>
                            <h4 class="fw-bold mb-0">@Model.TotalRevenue.ToString("N0")<small class="x-small">đ</small></h4>
                        </div>
                        <div class="p-2 bg-white bg-opacity-20 rounded-3 d-none d-sm-block">
                            <i class="bi bi-currency-dollar fs-5"></i>
                        </div>
                    </div>
                    <div class="mt-3 z-1">
                        <span class="badge bg-success bg-opacity-25 text-success rounded-pill x-small">+12.5%</span>
                    </div>
                    <i class="bi bi-cash-stack position-absolute opacity-10" style="bottom: -10px; right: -10px; font-size: 3.5rem;"></i>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card h-100 border-0 shadow-sm overflow-hidden" style="background: linear-gradient(135deg, #11998e, #38ef7d);">
                <div class="card-body text-white position-relative p-3 p-md-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="z-1">
                            <h6 class="text-white-50 x-small mb-1">ĐƠN HÀNG</h6>
                            <h4 class="fw-bold mb-0">@Model.TotalOrders</h4>
                        </div>
                        <div class="p-2 bg-white bg-opacity-20 rounded-3 d-none d-sm-block">
                            <i class="bi bi-cart-check fs-5"></i>
                        </div>
                    </div>
                    <div class="mt-3 z-1">
                        <span class="badge bg-white bg-opacity-25 text-white rounded-pill x-small">@(Model.TotalOrders > 10 ? "+5" : "0") mới</span>
                    </div>
                    <i class="bi bi-clock-history position-absolute opacity-10" style="bottom: -10px; right: -10px; font-size: 3.5rem;"></i>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card h-100 border-0 shadow-sm overflow-hidden" style="background: linear-gradient(135deg, #f09819, #edde5d);">
                <div class="card-body text-white position-relative p-3 p-md-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="z-1">
                            <h6 class="text-white-50 x-small mb-1">MÓN ĂN</h6>
                            <h4 class="fw-bold mb-0">@Model.TotalProducts</h4>
                        </div>
                        <div class="p-2 bg-white bg-opacity-20 rounded-3 d-none d-sm-block">
                            <i class="bi bi-egg-fried fs-5"></i>
                        </div>
                    </div>
                    <div class="mt-3 z-1">
                        <small class="text-white x-small">Đang mở bán</small>
                    </div>
                    <i class="bi bi-list-task position-absolute opacity-10" style="bottom: -10px; right: -10px; font-size: 3.5rem;"></i>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card h-100 border-0 shadow-sm overflow-hidden" style="background: linear-gradient(135deg, #8E2DE2, #4A00E0);">
                <div class="card-body text-white position-relative p-3 p-md-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="z-1">
                            <h6 class="text-white-50 x-small mb-1">KHÁCH HÀNG</h6>
                            <h4 class="fw-bold mb-0">@Model.TotalCustomers</h4>
                        </div>
                        <div class="p-2 bg-white bg-opacity-20 rounded-3 d-none d-sm-block">
                            <i class="bi bi-people fs-5"></i>
                        </div>
                    </div>
                    <div class="mt-3 z-1">
                        <span class="badge bg-white bg-opacity-25 text-white rounded-pill x-small">Verified</span>
                    </div>
                    <i class="bi bi-person-heart position-absolute opacity-10" style="bottom: -10px; right: -10px; font-size: 3.5rem;"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <!-- Revenue Chart -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0 fw-bold">Doanh Thu Theo Thời Gian</h5>
                        <small class="text-muted">Biểu đồ thể hiện mức tăng trưởng doanh thu</small>
                    </div>
                    <div class="btn-group btn-group-sm p-1 bg-light rounded-pill">
                        <button class="btn btn-light rounded-pill active px-3" onclick="updateChart('day', this)">Ngày</button>
                        <button class="btn btn-light rounded-pill px-3" onclick="updateChart('month', this)">Tháng</button>
                        <button class="btn btn-light rounded-pill px-3" onclick="updateChart('year', this)">Năm</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height:320px;">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Status -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0 fw-bold">Phân Loại Đơn Hàng</h5>
                    <small class="text-muted">Trạng thái xử lý hiện tại</small>
                </div>
                <div class="card-body">
                    <div class="chart-container mb-4" style="position: relative; height:200px;">
                        <canvas id="statusChart"></canvas>
                    </div>
                    <div class="list-group list-group-flush small">
                        @foreach (var stat in Model.OrderStatusCounts)
                        {
                            <div class="d-flex align-items-center justify-content-between py-2 border-bottom">
                                <span class="d-flex align-items-center gap-2">
                                    <span style="width: 8px; height: 8px; border-radius: 50%; background: @(GetStatusColor(stat.Key));"></span>
                                    @stat.Key
                                </span>
                                <span class="fw-bold">@stat.Value</span>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 pb-5">
        <!-- Top Products -->
        <div class="col-lg-5">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold">Món Bán Chạy</h5>
                    <i class="bi bi-trophy text-warning"></i>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        @foreach (var p in Model.TopSellingProducts)
                        {
                            <div class="list-group-item border-0 border-bottom-dashed py-3 px-4">
                                <div class="d-flex align-items-center gap-3">
                                    <img src="@(string.IsNullOrEmpty(p.ImageUrl) ? "/images/no-image.jpg" : p.ImageUrl)" 
                                         class="rounded-3 shadow-sm" style="width: 48px; height: 48px; object-fit: cover; border: 1px solid #eee;">
                                    <div class="flex-grow-1" style="min-width: 0;">
                                        <div class="fw-bold text-dark text-truncate small">@p.ProductName</div>
                                        <div class="text-muted small">@p.TotalRevenue.ToString("N0")đ</div>
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-bold text-accent">@p.TotalQuantity <span class="text-muted x-small">suất</span></div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Orders -->
        <div class="col-lg-7">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold">Đơn Hàng Mới</h5>
                    <a asp-controller="Orders" asp-action="Index" class="btn btn-sm btn-white border x-small">TẤT CẢ</a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive d-none d-lg-block">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light bg-opacity-50">
                                <tr class="text-muted small">
                                    <th class="ps-4 border-0">Mã Đơn</th>
                                    <th class="border-0">Khách hàng</th>
                                    <th class="border-0">Tổng tiền</th>
                                    <th class="border-0">Trạng thái</th>
                                    <th class="text-end pe-4 border-0">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var order in Model.RecentOrders)
                                {
                                    <tr style="font-size: 0.9rem;">
                                        <td class="ps-4 fw-bold text-dark">#@order.OrderNumber</td>
                                        <td>
                                            <div class="fw-medium">@order.Customer?.FullName</div>
                                            <small class="text-muted">@order.OrderDate.ToString("HH:mm, dd/MM")</small>
                                        </td>
                                        <td class="fw-bold text-accent">@order.TotalAmount.ToString("N0")đ</td>
                                        <td>
                                            @{ RenderStatusBadge(order.Status); }
                                        </td>
                                        <td class="text-end pe-4">
                                            <a asp-controller="Orders" asp-action="Details" asp-route-id="@order.OrderId" class="btn btn-sm btn-light border rounded-pill px-3">
                                                Quản lý
                                            </a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- Mobile List for Dashboard -->
                    <div class="d-lg-none">
                        @foreach (var order in Model.RecentOrders)
                        {
                            <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold text-dark mb-1">#@order.OrderNumber - @order.Customer?.FullName</div>
                                    <div class="text-muted x-small">@order.OrderDate.ToString("HH:mm, dd/MM") &bull; <span class="text-accent fw-bold">@order.TotalAmount.ToString("N0")đ</span></div>
                                </div>
                                <a asp-controller="Orders" asp-action="Details" asp-route-id="@order.OrderId" class="btn btn-sm btn-light border p-2">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@functions {
    string GetStatusColor(string status) {
        return status switch {
            "Chờ xác nhận" => "#ffc107",
            "Đã xác nhận" => "#0d6efd",
            "Đang chuẩn bị" => "#17a2b8",
            "Đang giao hàng" => "#6610f2",
            "Hoàn thành" => "#198754",
            "Đã hủy" => "#dc3545",
            _ => "#6c757d"
        };
    }
}

@{
    void RenderStatusBadge(OrderStatus status)
    {
        switch (status)
        {
            case OrderStatus.Pending:
                <span class="badge bg-warning-subtle text-warning border border-warning-subtle py-1 px-2 rounded-pill small">Chờ xử lý</span>
                break;
            case OrderStatus.Completed:
                <span class="badge bg-success-subtle text-success border border-success-subtle py-1 px-2 rounded-pill small">Hoàn thành</span>
                break;
            case OrderStatus.Cancelled:
                <span class="badge bg-danger-subtle text-danger border border-danger-subtle py-1 px-2 rounded-pill small">Đã hủy</span>
                break;
            default:
                <span class="badge bg-info-subtle text-info border border-info-subtle py-1 px-2 rounded-pill small">@status</span>
                break;
        }
    }
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const dayLabels = @Html.Raw(Json.Serialize(Model.DailyRevenue.Select(x => x.Label)));
        const dayValues = @Html.Raw(Json.Serialize(Model.DailyRevenue.Select(x => x.Value)));
        const monthLabels = @Html.Raw(Json.Serialize(Model.MonthlyRevenue.Select(x => x.Label)));
        const monthValues = @Html.Raw(Json.Serialize(Model.MonthlyRevenue.Select(x => x.Value)));
        const yearLabels = @Html.Raw(Json.Serialize(Model.YearlyRevenue.Select(x => x.Label)));
        const yearValues = @Html.Raw(Json.Serialize(Model.YearlyRevenue.Select(x => x.Value)));
        
        const statusLabels = @Html.Raw(Json.Serialize(Model.OrderStatusCounts.Keys));
        const statusValues = @Html.Raw(Json.Serialize(Model.OrderStatusCounts.Values));

        let ctxRevenue = document.getElementById('revenueChart').getContext('2d');
        let gradient = ctxRevenue.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(13, 110, 253, 0.2)');
        gradient.addColorStop(1, 'rgba(13, 110, 253, 0)');

        let revenueChart = new Chart(ctxRevenue, {
            type: 'line',
            data: {
                labels: dayLabels,
                datasets: [{
                    label: 'Doanh thu (đ)',
                    data: dayValues,
                    borderColor: '#0d6efd',
                    backgroundColor: gradient,
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0,
                    pointHoverRadius: 6,
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: '#0d6efd',
                    pointHoverBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: '#fff',
                        titleColor: '#001',
                        bodyColor: '#666',
                        borderColor: '#eee',
                        borderWidth: 1,
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                return ' Doanh thu: ' + context.parsed.y.toLocaleString('vi-VN') + 'đ';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { borderDash: [5, 5], color: '#f0f0f0' },
                        ticks: {
                            color: '#999',
                            font: { size: 11 },
                            callback: (v) => v >= 1000000 ? (v/1000000).toFixed(1) + 'M' : (v/1000).toFixed(0) + 'k'
                        }
                    },
                    x: { grid: { display: false }, ticks: { color: '#999', font: { size: 11 } } }
                }
            }
        });

        function updateChart(type, btn) {
            $('.btn-group .btn').removeClass('active');
            $(btn).addClass('active');
            
            if (type === 'day') {
                revenueChart.data.labels = dayLabels;
                revenueChart.data.datasets[0].data = dayValues;
            } else if (type === 'month') {
                revenueChart.data.labels = monthLabels;
                revenueChart.data.datasets[0].data = monthValues;
            } else if (type === 'year') {
                revenueChart.data.labels = yearLabels;
                revenueChart.data.datasets[0].data = yearValues;
            }
            revenueChart.update();
        }

        let ctxStatus = document.getElementById('statusChart').getContext('2d');
        new Chart(ctxStatus, {
            type: 'doughnut',
            data: {
                labels: statusLabels,
                datasets: [{
                    data: statusValues,
                    backgroundColor: ['#ffc107', '#0d6efd', '#17a2b8', '#6610f2', '#198754', '#dc3545'],
                    borderWidth: 8,
                    borderColor: '#fff',
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                cutout: '80%',
                radius: '90%'
            }
        });
    </script>
}
